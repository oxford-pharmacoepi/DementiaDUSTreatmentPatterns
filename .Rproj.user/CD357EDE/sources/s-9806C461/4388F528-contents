
install.packages("renv") # if not already installed, install renv from CRAN
renv::restore() # this should prompt you to install the various packages required for the study
renv::activate()

# packages -----
# load the below packages 
# you should have them all available, with the required version, after
# having run renv::restore above
#install.packages("remotes")
# install.packages("drat")
# drat::addRepo("OHDSI")
# install.packages("OhdsiSharing")
#remotes::install_github("mi-erasmusmc/TreatmentPatterns")
library(TreatmentPatterns)
library(DatabaseConnector)
library(CirceR)
library(CohortGenerator)
library(here)
library(stringr)
library(tibble)
library(dplyr)

# database metadata and connection details -----
# The name/ acronym for the database
db.name<-"CPRD_AURUM"

# database connection details
server     <- Sys.getenv("DB_SERVER_cdm_aurum_202106") # AURUM
server_dbi <- Sys.getenv("DB_SERVER_cdm_aurum_202106_dbi") #AURUM
user       <- Sys.getenv("DB_USER")
password   <- Sys.getenv("DB_PASSWORD")
port       <- Sys.getenv("DB_PORT") 
host       <- Sys.getenv("DB_HOST") 

# driver for DatabaseConnector
downloadJdbcDrivers("postgresql", here()) # if you already have this you can omit and change pathToDriver below
connectionDetails <- createConnectionDetails(dbms = "postgresql",
                                             server =server,
                                             user = user,
                                             password = password,
                                             port = port ,
                                             pathToDriver = here())

# sql dialect used with the OHDSI SqlRender package
targetDialect <-"postgresql" 
# schema that contains the OMOP CDM with patient-level data
cdm_database_schema<-"public"
# schema that contains the vocabularies
vocabulary_database_schema<-"public"
# schema where a results table will be created 
results_database_schema<-"results"

# stem for tables to be created in your results schema for this analysis
# You can keep the above names or change them
# Note, any existing tables in your results schema with the same name will be overwritten
cohortTableStem<-"DemDUSTreatPats"

# Check database connections -----
# to check whether the OHDSI DatabaseConnector worked, uncomment and run the below three lines
conn <- connect(connectionDetails)
querySql(conn,paste0("SELECT COUNT(*) FROM ", cdm_database_schema, ".person"))
disconnect(conn)

# Run analysis ----
source(here("RunAnalysis.R"))

# Review results -----
TreatmentPatterns::launchResultsExplorer(saveSettings = saveSettings)
TreatmentPatterns::launchResultsExplorer(outputFolder = file.path(saveSettings$rootFolder, "ouput"))
TreatmentPatterns::launchResultsExplorer(zipFolder = saveSettings$rootFolder)
